<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrovaFamiglia v3.0</title>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- CSS Esterno -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="title-icon">
            <i class="ph-fill ph-radar"></i>
        </div>
        <h1>TrovaFamiglia</h1>
        <p style="color:#94a3b8; margin-bottom: 2rem;">Inserisci nome e password</p>

        <input type="text" id="username" placeholder="Nome (Es. Mario)" autocomplete="off">
        <input type="password" id="password" placeholder="Password" style="margin-top: 10px;">
        <button onclick="handleLogin()" style="margin-top: 20px;">ENTRA / REGISTRATI</button>
        <p id="status-msg" style="margin-top:1rem; color: #ef4444; height: 1.2em; text-align:center;"></p>
    </div>

    <!-- MAP SCREEN -->
    <div id="map-wrapper">
        <div id="map"></div>
    </div>

    <!-- UI OVERLAYS (Outside map wrapper to avoid rotation) -->
    <div id="ui-layer">
        
        <!-- GPS Status Overlay -->
        <div id="gps-controls">
            <div id="gps-toggle-btn" onclick="toggleLocalTracking()">
                <div id="gps-dot"></div>
                <span id="gps-text" style="font-size: 0.75rem; margin-left: 5px;">GPS</span>
            </div>
        </div>

        <!-- Fit Bounds Button -->
        <div id="fit-bounds-btn" onclick="fitAllUsers()">
            <i class="ph ph-corners-out"></i>
        </div>

        <!-- Follow Mode Indicator -->
        <div id="follow-mode-indicator" class="hidden" onclick="stopFollowing()">
            <i class="ph-fill ph-navigation-arrow"></i> STOP SEGUI
        </div>

        <div id="logout-btn" onclick="doLogout()">Esci</div>

        <!-- Users Menu -->
        <div id="users-menu-wrapper">
            <div id="users-menu-btn" onclick="toggleUserMenu()">
                ðŸ‘¥ Utenti
            </div>
            <div id="users-list-dropdown" class="hidden">
                <!-- Populated by JS -->
            </div>
        </div>

        <div id="admin-btn" class="hidden" onclick="openAdmin()">
            <i class="ph ph-gear" style="font-size: 1.5rem; color: white;"></i>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h2>Gestione Utenti</h2>
            <div style="display:flex; gap:10px;">
                <button onclick="createNewGroup()" style="width:auto; padding:8px 12px; font-size:0.9rem; background:#3b82f6;">âž• Nuovo Gruppo</button>
                <button onclick="closeAdmin()" style="width:auto; background:transparent; border:1px solid white;">Chiudi</button>
            </div>
        </div>

        <div id="admin-settings">
            <h3 style="color:white; margin-bottom:0.5rem;">Impostazioni Amministratore</h3>
            <div style="display:flex; align-items:center;">
                <input type="checkbox" id="tracking-toggle" checked onchange="toggleMyTracking()" style="width:auto; margin:0 10px 0 0;">
                <label for="tracking-toggle" style="color:white;">Rileva la mia posizione</label>
            </div>
            <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 10px;">
                Gestisci i gruppi per controllare la visibilitÃ  tra utenti. L'admin vede tutti.
            </p>
        </div>

        <div id="user-list">
            <!-- Users Injected Here -->
        </div>
    </div>

    <!-- App Logic -->
    <script src="app.js"></script>
</body>

</html>
